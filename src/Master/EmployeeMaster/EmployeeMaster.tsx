import SideBar from "../../SideBar/SideBar";
import { Modal, Button } from "react-bootstrap";
import { useState, useEffect, useRef } from "react";
import Table from "../../DataTable/DataTable";
import { MultiSelect } from "react-multi-select-component";
import { useSelector, useDispatch } from "react-redux";
import { employeeActions } from "../../Store/Slices/Employee";
import { read, utils, writeFile } from "xlsx";
import { marketActions } from "../../Store/Slices/Market";
import { toast } from "react-toastify";
import { filterActions } from "../../Store/Slices/Filters";
import DownloadBtn from "../../Export/DownloadBtn";
import { PatternsAndMessages } from "../../utils/ValidationPatternAndMessage";
import { validateForm, validateSingleFormGroup } from "../../utils/validations";
import { DELETE_RESOURCE, GET_ALL_LOCATIONS, GET_ALL_MARKETS, GET_ALL_RESOURCES, GET_ALL_SUB_LOCATIONS, POST_BULK_UPLOAD_EMPLOYEE, POST_RESOURCE, UPDATE_RESOURCE } from "../../constants";
import { RotatingLines } from "react-loader-spinner";
import { closeNav } from "../../SideBar/SideBarJs";


const columns = [
  {
    name: "Resource",
    selector: (row: { resourceName: any }) => row.resourceName,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Role",
    selector: (row: { role: any }) => row.role == "0" ? "" : row.role,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Email Address",
    selector: (row: { emailAddress: any }) => row.emailAddress,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Manager",
    selector: (row: { manager: any }) => row.manager,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Resource Type",
    selector: (row: { resourceType: any }) => row.resourceType == "0" ? "" : row.resourceType,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Part Time",
    selector: (row: { partTime: any }) => row.partTime === true ? "Yes" : "No",
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Capacity Per Day",
    selector: (row: { capacityPerDay: any }) => row.capacityPerDay,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Market",
    selector: (row: { resourceMarket: any }) => row.resourceMarket == "0" ? "" : row.resourceMarket,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Location",
    selector: (row: { location: any }) => row.location == "0" ? "" : row.location,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Sub Location",
    selector: (row: { subLocation: any }) => row.subLocation == "0" ? "" : row.subLocation,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Status",
    selector: (row: { isActive: any }) => row.isActive,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Created Date",
    selector: (row: { createdDateString: any }) => row.createdDateString,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Created By",
    selector: (row: { createdBy: any }) => row.createdBy,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Updated Date",
    selector: (row: { updatedDateString: any }) => row.updatedDateString,
    sortable: true,
    reorder: true,
    filterable: true,
  },
  {
    name: "Updated By",
    selector: (row: { updatedBy: any }) => row.updatedBy,
    sortable: true,
    reorder: true,
    filterable: true,
  },
];


const customValueRenderer = (selected: any, _options: any) => {
  if (selected.length == "0") return "Select";
  else if (selected.length == "1") return selected[0].label;
  else return selected.length + " items selected";
};

const EmployeeMaster = () => {
  const dispatch = useDispatch();
  const username=useSelector((state:any)=>state.User.username);
  const roles = useSelector((state: any) => state.Filters.roles);
  const resourceTypes = useSelector((state: any) => state.Filters.resourceTypes);
  const status = useSelector((state: any) => state.Filters.status);
  const toggle = useSelector((state: any) => state.Employee.toggle);
  const resources = useSelector((state: any) => state.Employee.data);
  const marketList = useSelector((state: any) => state.Market.data);
  const marketSelected = useSelector((state: any) => state.Employee.market);
  const roleSelected = useSelector((state: any) => state.Employee.role);
  const resourceTypeSelected = useSelector((state: any) => state.Employee.resourceType);
  const statusSelected = useSelector((state: any) => state.Employee.status);
  const managerSelected = useSelector((state: any) => state.Employee.manager);
  const [showModal, setShowModal] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  
  const [action, setAction] = useState("Add");
  const [updateResourceDetails, setUpdateResourceDetails] = useState({});
  const openModal = () => {
    setShowModal(true);
  }
  console.log("Username: ", username);
  const closeModal = () => {
    setShowModal(false);
    setAction("Add");
  }
  const changeMarketSelectHandler = (event: any) => {
    dispatch(employeeActions.changeMarket(event));
  };
  const changeRoleSelectHandler = (event: any) => {
    dispatch(employeeActions.changeRole(event));
  };
  const changeResourceTypeSelectHandler = (event: any) => {
    dispatch(employeeActions.changeResourceType(event));
  };

  const changeStatusSelectHandler = (event: any) => {
    dispatch(employeeActions.changeStatus(event));
  };
  const changeManagerSelectHandler = (event: any) => {
    dispatch(employeeActions.changeManager(event));
  };

  const getEmployeeDetails = async () => {
    try {
      const response = await fetch(`${GET_ALL_RESOURCES}`);
      let dataGet = await response.json();
      dataGet = dataGet.map((row: any) => ({ ...row, isActive: row.isActive ,createdDate:row.createdDateString,updatedDate:row.updatedDateString}));
      dispatch(employeeActions.changeData(dataGet));
      setTimeout(()=>setIsLoading(false), 2000);
    } catch {
      console.log("Error occured");
    }
  };
  useEffect(() => {
    getEmployeeDetails();
  }, [toggle]);
useEffect(()=>{
  dispatch(employeeActions.clearFilters());
  dispatch(employeeActions.changeStatus([{label:'Active', value:'Active'}]));
},[])
  const getMarketDetails = async () => {
    const response = await fetch(`${GET_ALL_MARKETS}`);
    let dataGet = await response.json();
    dataGet = dataGet.map((row: any) => ({ ...row,createdDate:row.createdDateString,updatedDate:row.updatedDateString}));
    dispatch(marketActions.changeData(dataGet));
  };
  const getLocationDetails = async () => {
    const response = await fetch(`${GET_ALL_LOCATIONS}`);
    const dataGet = await response.json();
    dispatch(filterActions.changeLocations(dataGet));
  }
  const getSubLocationDetails = async () => {
    const response = await fetch(`${GET_ALL_SUB_LOCATIONS}`);
    const dataGet = await response.json();
    dispatch(filterActions.changeSubLocations(dataGet));
  }
  useEffect(() => {
    getMarketDetails();
    getLocationDetails();
    getSubLocationDetails();
  }, []);

  const resourceColumns = [
    ["Resource Name","Role", "Email Address", "Manager", "Resource Type", "Resource Market",  "Location", "Sub Location"],
  ];
  const handleDownloadTemplate = async () => {
    const fileType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=UTF-8";
    const fileExtension = ".xlsx";
    const wb = utils.book_new();
    const ws = utils.json_to_sheet([]);
    utils.sheet_add_aoa(ws, resourceColumns);
    utils.book_append_sheet(wb, ws, "ResourceTemplate");
    writeFile(wb, "Resource.xlsx");
  };

  const [path, setPath] = useState("");
  const sendBulkResourcesData = async (payload: any) => {
    if (payload.length) {
      console.log("Payload: ",payload);
      payload = payload.map((row: any) => ({
        resourceName: row["Resource Name"],
        resourceType: row["Resource Type"],
        role: row.Role,
        resourceMarket: row["Resource Market"],
        emailAddress: row["Email Address"],
        location: row.Location,
        subLocation: row["Sub Location"],
        manager: row.Manager,
      }));
      payload = payload.map((row: any) => ({ ...row, createdBy: username }));
      try {
        const response = await fetch(`${POST_BULK_UPLOAD_EMPLOYEE}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        const dataResponse = await response.json();
        if (dataResponse.length) {
          if (dataResponse[0].statusCode == "201") {
            console.log(dataResponse[0].statusReason);
            console.log(dataResponse[0].recordsCreated);
            dispatch(employeeActions.changeToggle());
            toast.success(dataResponse[0].recordsCreated + " Resources Added Successfully")
          } else toast.error(dataResponse[0].errorMessage);
        } else toast.error("Some Error occured.");
      } catch {
        toast.error("Some Error occured.");
      }
    }
  };
  const handleUploadResourceFile = async (event: any) => {
    const files = event.target.files;

    if (files.length) {
      const file = files[0];
      const reader = new FileReader();
      reader.onload = (event: any) => {
        const wb = read(event.target.result);
        const sheets = wb.SheetNames;
        if (sheets.length) {
          const rows: any = utils.sheet_to_json(wb.Sheets[sheets[0]]);
          sendBulkResourcesData(rows);
          setPath("");
        }
      };
      reader.readAsArrayBuffer(file);
    }
  };

  const filteredResources = resources.filter(
    (resource: any) => {
      const marketOptions = marketSelected.map((market: any) => market.value);
      const resourceTypeOptions = resourceTypeSelected.map((resourceType: any) => resourceType.value);
      const roleOptions = roleSelected.map((role: any) => role.value);
      const statusOptions = statusSelected.map((status: any) => status.value);
      const managerOptions = managerSelected.map((manager: any) => manager.value);
      if ((!marketSelected.length) || (marketSelected.length > 0 && marketOptions.includes(resource.resourceMarket) == true)) {

        if ((!resourceTypeSelected.length) || (resourceTypeSelected.length > 0 && resourceTypeOptions.includes(resource.resourceType) == true)) {

          if ((!roleSelected.length) || (roleSelected.length > 0 && roleOptions.includes(resource.role) == true)) {

            if ((!statusSelected.length) || (statusSelected.length > 0 && statusOptions.includes(resource.isActive))) {
              if ((!managerSelected.length) || (managerSelected.length > 0 && managerOptions.includes(resource.manager)))
                return true;
            }
          }
        }
      }
      return false;
    }
  );
  const managers: any = [];
  resources.map((resource: any) => {
    if (managers.indexOf(resource.manager) === -1) {
      managers.push(resource.manager);
    }
  })
  const handleRowDoubleClicked = (row: any) => {
    setShowModal(true);
    setAction("Update");
    let data = { ...row, isActive: row.isActive  }
    setUpdateResourceDetails(data);
  };

  //start constants for export
  const columnsAndSelectors=[
    {'name': 'Resource' , 'selector': 'resourceName','default':'true'},
    {'name': 'Role' , 'selector': 'role','default':'true'},
    {'name': 'Email Address', 'selector': 'emailAddress','default':'false' },
    {'name': 'Manager', 'selector': 'manager','default':'true'},
    {'name': 'Resource Type', 'selector': 'resourceType','default':'true'},
    {'name': 'Part Time', 'selector' : 'partTime','default':'false'},
    {'name': 'Capacity Per Day', 'selector' : 'capacityPerDay','default':'false'},
    {'name': 'Market', 'selector': 'resourceMarket','default':'true'},
    {'name': 'Location', 'selector': 'location','default':'true'},
    {'name': 'Sub Location', 'selector':'subLocation','default':'true' },
    {'name': 'Status', 'selector' : 'isActive','default':'true'},
    {'name': 'Created Date', 'selector' : 'createdDate','default':'true'},
    {'name': 'Created By', 'selector' : 'createdBy','default':'true'},
    {'name': 'Updated Date', 'selector' : 'updatedDate','default':'false'},
    {'name': 'Updated By', 'selector' : 'updatedBy','default':'false'},
  ]
  const title = "Resource Details";
  //end constants for export

  return (
    <div>
      <SideBar></SideBar>
      {isLoading ? <div className="SpinnerLoader" style={{height:'110vh',textAlign:'center', justifyContent:'center', margin:'auto', display:'flex'}}>
        <RotatingLines
          strokeColor="#fa600d"
          strokeWidth="5"
          animationDuration="0.75"
          width="96"
          visible={true}
        />
      </div> :
      <div className="col-md-12 bg-mainclass" onClick={closeNav}>
        <div>
          <div className="row Page-Heading">
            <h1 className="Heading-Cls">Resource Details</h1>
            <p>
              <span className="Heading-P-Cls">Master</span>
              <span>Resource Details</span>
            </p>
            <div className="btns employee" style={{marginLeft:"15px"}}>
              <div style={{display:'flex', width:'230px',float:'right', marginTop:'-15px'}}>
              <div className="DownloadEmployeeTemplate" >
                <button  type="button" className="btn btn-primary download-button-btn" onClick={handleDownloadTemplate}>
                  <i className="las la-file-download"></i>
                </button>
                <div className="DownloadEmployeeTemplateTooltip">
                  <p>
                    Download Template
                  </p>
                </div>
              </div>
              <div className="UploadBulkEmployeeDetails" >
                <button  type="button" className="btn btn-primary upload-button-btn">
                  <i className="las la-file-upload"></i>
                </button>
                <input
                  type="file"
                  value=""
                  id="input-resources-file"
                  className="btn btn-primary custom-file-input upload-input-btn"
                  accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel"
                  onChange={handleUploadResourceFile}
                />
                <div className="BulkUploadEmployeeTooltip">
                  <p>
                    Add Bulk Resources
                  </p>
                </div>
              </div>
              <div className="AddEmployeeButton" style={{ whiteSpace:'nowrap'}}>
                {action == "Add" && <AddModal showModal={showModal} openModal={openModal} closeModal={closeModal} />}
                {action == "Update" && <UpdateModal initialValues={updateResourceDetails} onSave={onSave} showModal={showModal} openModal={openModal} closeModal={closeModal} />}
              </div>
              </div>
            </div>
          </div>
          <div className="row filter-row">

            <div className="col-md-2 form-group">
              <label htmlFor="" className="form-label">
                Role
              </label>
              <MultiSelect
                options={roles.map((role: any) => ({ label: role, value: role }))}
                value={roleSelected}
                onChange={changeRoleSelectHandler}
                labelledBy="Select Role"
                valueRenderer={customValueRenderer}
              />
            </div>

            <div className="col-md-2 form-group">
              <label htmlFor="" className="form-label">
                Manager
              </label>
              <MultiSelect
                options={managers.map((manager: any) => ({ label: manager, value: manager }))}
                value={managerSelected}
                onChange={changeManagerSelectHandler}
                labelledBy="Select Manager"
                valueRenderer={customValueRenderer}
              />
            </div>
            <div className="col-md-2 form-group">
              <label htmlFor="" className="form-label">
                Resource Type
              </label>
              <MultiSelect
                options={resourceTypes.map((resourceType: any) => ({ label: resourceType, value: resourceType }))}
                value={resourceTypeSelected}
                onChange={changeResourceTypeSelectHandler}
                labelledBy="Select Resource Type"
                valueRenderer={customValueRenderer}
              />
            </div>
            <div className="col-md-2 form-group">
              <label htmlFor="" className="form-label">
                Market
              </label>
              <MultiSelect
                options={(marketList.filter((market:any) => market.status === "Active" ).map((market: any) => ({ label: market.marketName, value: market.marketName })))}
                value={marketSelected}
                onChange={changeMarketSelectHandler}
                labelledBy="Select Market"
                valueRenderer={customValueRenderer}
              />
            </div>
            <div className=" col-md-2 form-group">
              <label htmlFor="activeDropdown" className="form-label">
                Status
              </label>
              <MultiSelect
                options={status.map((status: any) => ({ label: status, value: status }))}
                value={statusSelected}
                onChange={changeStatusSelectHandler}
                labelledBy="Select Status"
                valueRenderer={customValueRenderer}
              />
            </div>
            <div className="col-md-2 form-group" style={{ marginTop: "24px", marginLeft:'-3px', whiteSpace:'nowrap'  }}>
              <button type="button"  className="btn btn-primary PAllocationFilters" onClick={() => dispatch(employeeActions.clearFilters())}>Clear Filters<i className="las la-filter"></i></button>
            </div>
          </div>
        <div className="TableContentBorder" >
        <Table columnsAndSelectors={columnsAndSelectors}columns={columns} isLoading={isLoading} data={filteredResources} onRowDoubleClicked={handleRowDoubleClicked} title={title}/>
        </div>
        </div>
      </div>}
    </div>
  );
};

const AddModal = (props: any) => {
  const dispatch = useDispatch();
  const username=useSelector((state:any)=>state.User.username);
  const roles = useSelector((state: any) => state.Filters.roles);
  const resourceTypes = useSelector((state: any) => state.Filters.resourceTypes);
  const marketList = useSelector((state: any) => state.Market.data);
  const locations = useSelector((state: any) => state.Filters.locations);
  const subLocations = useSelector((state: any) => state.Filters.subLocations);
  const resourceList = useSelector((state: any) => state.Employee.data);
  console.log("Resource List: ", resourceList);
  const [employeeName, setEmployeeName] = useState("");
  const [role, setRole] = useState("0");
  const [manager, setManager] = useState("");
  const [resourceType, setResourceType] = useState("0");
  const [location, setLocation] = useState("0");
  const [subLocation, setSubLocation] = useState("0");
  const [market, setMarket] = useState("0");
  const [employeeEmailAddress, setEmployeeEmailAddress] = useState("");
  const [isPartTime, setIsPartTime] = useState(false);
  const [capacityPerDay, setCapacityPerDay] = useState(0);
  const [disableCheckBox, setDisableCheckBox] = useState(true);
  let resourceManagers = resourceList.filter((resource: any)=> resource.role.search(/Manager/i) != -1 || resource.role.search(/Director/i) != -1);

  const formSubmitHandler = async (event: any) => {
    event.preventDefault();
    let payload = {
      resourceName: employeeName,
      role: role,
      manager: manager,
      resourceType: resourceType,
      partTime: isPartTime,
      capacityPerDay:capacityPerDay,
      location: location,
      subLocation: subLocation,
      resourceMarket: market,
      emailAddress: employeeEmailAddress,
      createdBy: username,
    };
    try {
      if(validateForm('#AddEmployeeForm')){
        const response = await fetch(`${POST_RESOURCE}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        const dataResponse = await response.json();
        if (dataResponse.length) {
          if (dataResponse[0].statusCode == "201") {
            console.log(dataResponse[0].statusReason);
            console.log(dataResponse[0].recordsCreated);
  
            dispatch(employeeActions.changeToggle());
            resetFormFields();
            props.closeModal();
            toast.success("Resource Added Successfully")
          } else toast.error(dataResponse[0].errorMessage);
        } else toast.error("Some Error occured.");
      }
    } catch {
      toast.error("Some Error occured.");
    }
  };

  const resetFormFields = () => {
    const errorContainer = document.getElementsByClassName('error');
    for(let i=0; i < errorContainer.length; i++){
      errorContainer[i].textContent='';
    }
    setEmployeeName("");
    setRole("0");
    setManager("");
    setResourceType("0");
    setLocation("0");
    setSubLocation("0");
    setMarket("0");
    setEmployeeEmailAddress("");
    setIsPartTime(false);
    setDisableCheckBox(true);
  };

  function handleChange(event: any) {
    let partTimeCheck = document.getElementById('PartTimeField') as HTMLInputElement;
    if(partTimeCheck?.checked == true){
      setIsPartTime(true);
      if(event.target.value === "GTM" || event.target.value ==="FTE"){
        setCapacityPerDay(4);
      }else{
        setCapacityPerDay(4.25);
      }
    }else{
      setIsPartTime(false);
      if(event.target.value === "GTM" || event.target.value ==="FTE"){
        setCapacityPerDay(8);
      }else{
        setCapacityPerDay(8.5);
      }
      // console.log("Not a part time: ", event);
    }
  }
function manageCheckBox(e: any){
  setResourceType(e.target.value);
  if(e.target.value==="OGA" || e.target.value==="GTM" || e.target.value==="FTE"){
    setDisableCheckBox(false);
    handleChange(e);
  }else{
    setDisableCheckBox(true);
    handleChange(e);
  }
}
  return (
    <>
      <Button
        className="btn btn-primary"
        style={{ float: "right", marginTop: "-68px"}}
        
        variant="primary"
        onClick={props.openModal}
      >
        <i className="las la-plus"></i> Add Resource
      </Button>
      <Modal show={props.showModal} onHide={props.closeModal}>
        <Modal.Header closeButton onClick={props.closeModal}>
          <Modal.Title>
            <h6>Add New Resource</h6>
          </Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <form onSubmit={formSubmitHandler} id="AddEmployeeForm" noValidate>
            <div className="row">
              <div className="col-md-6 form-group" id="AddResourceField">
                <label className="form-label">Resource</label>
                <span className="requiredField">*</span>
                <input
                  required
                  pattern={PatternsAndMessages.nameLike.pattern}
                  type="text"
                  className="form-control"
                  id="resource"
                  value={employeeName}
                  onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceField'), 'input')}
                  onChange={(event) => setEmployeeName(event.target.value)}
                />
                <div className="error"></div>
              </div>
              <div className="col-md-6 form-group " id="AddRoleField">
                <label className="form-label">Role</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    required
                    id="employeeRole"
                    className="form-control"
                    value={role}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('AddRoleField'), 'select')}
                    onChange={(event) => {setRole(event.target.value);
                      validateSingleFormGroup(document.getElementById('AddRoleField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {roles.map((role: any) => (<option key={role} value={role}>{role}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group" id="AddResourceEmailField">
                <label className="form-label">Email Address</label>
                {/* <span className="requiredField">*</span> */}
                <input
                  // required
                  pattern={PatternsAndMessages.email.pattern}
                  type="text"
                  className="form-control"
                  id="employeeEmailAddress"
                  value={employeeEmailAddress}
                  // onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceEmailField'),'input')}
                  onChange={(event) => {setEmployeeEmailAddress(event.target.value);
                    // validateSingleFormGroup(document.getElementById('AddResourceEmailField'),'input')
                  }}
                />
                {/* <div className="error"></div> */}
              </div>
              <div className="col-md-6 form-group" id="AddResourceManagerField">
                <label className="form-label">Manager</label>
                <span className="requiredField">*</span>
                <div className="">
                  <input
                    required
                    list="managerRecommendation"
                    className="form-control"
                    pattern={PatternsAndMessages.nameLike.pattern}
                    id="manager"
                    value={manager}
                    onChange={(event) => {
                      setManager(event.target.value);
                      validateSingleFormGroup(document.getElementById('AddResourceManagerField'), 'input');
                    }}
                  />
                      <datalist id="managerRecommendation" className="managerRecommendation" style={{width:'100% !important',position:'absolute',right:'1000px'}}>
                        {resourceManagers.filter((resource: any) => resource.isActive == "Active").map((resource: any) => <option key={resource.resourceId} value={resource.resourceName.toString()}>{resource.resourceName}</option>)}
                      </datalist>
                </div>
                  <div className="error"></div>      
              </div>
              <div className="col-md-6 form-group" id="AddResourceResourceTypeField">
                <label className="form-label">Resource Type</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    required
                    id="resourceType"
                    className="form-control"
                    value={resourceType}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceResourceTypeField'),'select')}
                    onChange={(event) => {
                      setResourceType(event.target.value);
                      console.log("Resource Type: ", resourceType);
                      console.log("Resource Type Selected: ", event.target.value);
                      manageCheckBox(event);
                      validateSingleFormGroup(document.getElementById('AddResourceResourceTypeField'),'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {resourceTypes.map((resourceType: any) => (<option key={resourceType} value={resourceType}>{resourceType}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              
              <div className="col-md-6 form-group" id="">
                <div className="" style={{alignItems:'center', marginTop:'12.5%'}}>
                  <input type="checkbox" onChange={handleChange} id="PartTimeField" disabled={disableCheckBox} name="PartTimeField" checked={isPartTime} value="partTime"/>
                  <label className="form-label" style={{marginLeft:'5px'}}>Part Time</label>
                </div>
              </div>
              <div className="col-md-6 form-group" id="AddResourceMarketField">
                <label className="form-label">Market</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="market"
                    required
                    className="form-control"
                    value={market}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceMarketField'), 'select')}
                    onChange={(event) => {setMarket(event.target.value);
                      validateSingleFormGroup(document.getElementById('AddResourceMarketField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {marketList.filter((market: any) => market.status == "Active").map((market: any) => <option key={market.id} value={market.marketName}>{market.marketName}</option>)}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group" id="AddResourceLocationField">
                <label className="form-label">Location</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="location"
                    required
                    className="form-control"
                    value={location}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceLocationField'), 'select')}
                    onChange={(event) => {setLocation(event.target.value);
                      validateSingleFormGroup(document.getElementById('AddResourceLocationField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {locations.map((location: any) => (<option key={location.locationId} value={location.locationName}> {location.locationName}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>

              <div className="col-md-6 form-group " id="AddResourceSubLocationField">
                <label className="form-label">Sub Location</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    className="form-control"
                    required
                    id="holidaySubLocation"
                    value={subLocation}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('AddResourceSubLocationField'), 'select')}
                    onChange={(event: any) => {setSubLocation(event.target.value);
                      validateSingleFormGroup(document.getElementById('AddResourceSubLocationField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {location == "0" ? [] : (subLocations.filter((subLocation: any) => location == subLocation.locationName).map((subLocation: any) => (<option key={subLocation.subLocationId} value={subLocation.subLocationName}>{subLocation.subLocationName}</option>)))}
                  </select>
                <div className="error"></div>
                </div>
              </div>

            </div>
            <div className="row">
              <div className="col-md-8">
                
              </div>
              <div className="col-md-4" >
              <button type="reset" onClick={resetFormFields} className="btn btn-primary resetButton" >
                  Reset
              </button>
              <button type="submit" className="btn btn-primary" style={{ float: "right" }}>
                  Add
                </button>
              </div>
            </div>
          </form>
        </Modal.Body>
      </Modal>
    </>
  );
};

const onSave = (props: any) => {
  console.log(props);
}

const UpdateModal = (props: any) => {
  const dispatch = useDispatch();
  const username=useSelector((state:any)=>state.User.username);
  const locations = useSelector((state: any) => state.Filters.locations);
  const subLocations = useSelector((state: any) => state.Filters.subLocations);
  const roles = useSelector((state: any) => state.Filters.roles);
  const resourceTypes = useSelector((state: any) => state.Filters.resourceTypes);
  const marketList = useSelector((state: any) => state.Market.data);
  const [formValues, setFormValues] = useState(props.initialValues || { location: "0" });
  let location = formValues.location;
  const resourceList = useSelector((state: any) => state.Employee.data);
  const [isPartTime, setIsPartTime] = useState(formValues.partTime);
  const [capacityPerDay, setCapacityPerDay] = useState(formValues.capacityPerDay);
  const [disableCheckBox, setDisableCheckBox] = useState(false);
  
  let resourceManagers = resourceList.filter((resource: any)=> resource.role.search(/Manager/i ) != -1 || resource.role.search(/Director/i) != -1 );


  const handleSave = async (event: any) => {
    event.preventDefault();
    let payload = {
      resourceId: formValues.resourceId,
      resourceName: formValues.resourceName,
      role: formValues.role,
      manager: formValues.manager,
      resourceType: formValues.resourceType,
      capacityPerDay: capacityPerDay,
      partTime: isPartTime,
      location: formValues.location,
      subLocation: formValues.subLocation,
      resourceMarket: formValues.resourceMarket,
      emailAddress: formValues.emailAddress,
      isActive: formValues.isActive,
      updatedBy: username,
    };
    try {
      if(validateForm('#UpdateResourceForm')){
        const response = await fetch(`${UPDATE_RESOURCE}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });
        const dataResponse = await response.json();
        if (dataResponse.length) {
          if (dataResponse[0].statusCode == "201") {
            console.log(dataResponse[0].statusReason);
            console.log(dataResponse[0].recordsCreated);
            dispatch(employeeActions.changeToggle());
            props.closeModal();
            toast.success("Resource Updated Successfully")
          } else toast.error(dataResponse[0].errorMessage);
        } else toast.error("Some Error occured.");
      }
    } catch {
      toast.error("Some Error occured.");
    }
  };


  const handleChange = (e: any) => {
    console.log("Update")
    setFormValues({
      ...formValues,
      [e.target.name]: e.target.value
    });
    let partTimeCheck = document.getElementById('PartTimeField') as HTMLInputElement;
    if(partTimeCheck?.checked == true){
      // console.log("Part time: ", event);
      setIsPartTime(true);
      if(formValues.resourceType === "GTM" || formValues.resourceType ==="FTE"){
        setCapacityPerDay(4);
      }else{
        setCapacityPerDay(4.25);
      }
    }else{
      setIsPartTime(false);
      if(formValues.resourceType === "GTM" || formValues.resourceType ==="FTE"){
        setCapacityPerDay(8);
      }else{
        setCapacityPerDay(8.5);
      }
      // console.log("Not a part time: ", event);
    }
  };
  
  const getEmployeeDetails = async () => {
    try {
      const response = await fetch(`${GET_ALL_RESOURCES}`);
      let dataGet = await response.json();
      dataGet = dataGet.map((row: any) => ({ ...row, isActive: row.isActive ,createdDate:row.createdDateString,updatedDate:row.updatedDateString}));
      dispatch(employeeActions.changeData(dataGet));
      } catch {
      console.log("Error occured");
    }
  };

  function manageCheckBox(e: any){
    if(e.target.value==="OGA" || e.target.value==="GTM" || e.target.value==="FTE"){
      setDisableCheckBox(false);
    }else{
      setDisableCheckBox(true);
    }
  }
  
  function deleteConfirmation() {
    var txt;
    if (window.confirm(`Do you want to delete this record?`)) {
      txt = "You pressed OK!";
      handleDelete();
    } else {
      txt = "You pressed Cancel!";
    }
  }
  const handleDelete = async()=>{
    // id: formValues.id,
    const response = await fetch(`${DELETE_RESOURCE}/${formValues.resourceId}`);
    getEmployeeDetails();
    props.closeModal();
  }
  return (
    <>
      <Button
        className="btn btn-primary"
        style={{ float: "right", marginTop: "-68px", padding:"3px 6px 4px 6px", borderRadius:"4px" }}
        
        variant="primary"
        onClick={props.openModal}
      >
        <i className="las la-plus"></i> Add Employee
      </Button>
      <Modal show={props.showModal} onHide={props.closeModal}>
        <Modal.Header closeButton onClick={props.closeModal}>
          <Modal.Title>
            <h6>Update Resource</h6>
          </Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <form onSubmit={handleSave} id="UpdateResourceForm" noValidate>
            <div className="row">
              <div className="col-md-6 form-group" id="UpdateResourceResourceField">
                <label className="form-label">Resource</label>
                <span className="requiredField">*</span>
                <input
                  type="text"
                  required
                  pattern={PatternsAndMessages.nameLike.pattern}
                  name="resourceName"
                  className="form-control"
                  id="resource"
                  value={formValues.resourceName}
                  onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceResourceField'), 'input')}
                  onChange={handleChange}
                />
                <div className="error"></div>
              </div>
              <div className="col-md-6 form-group " id="UpdateResourceRoleField">
                <label className="form-label">Role</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="employeeRole"
                    required
                    name="role"
                    className="form-control"
                    value={formValues.role}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceRoleField'), 'select')}
                    onChange={(e: any) => {handleChange(e);
                      validateSingleFormGroup(document.getElementById('UpdateResourceRoleField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {roles.map((role: any) => (<option key={role} value={role}>{role}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group" id="UpdateResourceEmailField">
                <label className="form-label">Email Address</label>
                {/* <span className="requiredField">*</span> */}
                <input
                  type="text"
                  // required
                  pattern={PatternsAndMessages.email.pattern}
                  name="emailAddress"
                  className="form-control"
                  id="employeeEmailAddress"
                  value={formValues.emailAddress}
                  // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceEmailField'), 'input')}
                  onChange={handleChange}
                />
                {/* <div className="error"></div> */}
              </div>
              <div className="col-md-6 form-group" id="UpdateResourceManagerField">
                <label className="form-label">Manager</label>
                <span className="requiredField">*</span>
                <div className="">
                <input
                    required
                    className="form-control"
                    list="updateManagerRecommendation"
                    id="manager"
                    pattern={PatternsAndMessages.nameLike.pattern}
                    name="manager"
                    value={formValues.manager}
                    onChange={(event) => {
                      // setManager(event.target.value);
                      handleChange(event);
                      validateSingleFormGroup(document.getElementById('UpdateResourceManagerField'), 'input');
                    }}
                    />
                    <datalist id="updateManagerRecommendation" className="managerRecommendation" style={{marginLeft:"-100px !important"}}>
                      {resourceManagers.filter((resource: any) => resource.isActive == "Active").map((resource: any) => <option key={resource.resourceId} value={resource.resourceName.toString()}>{resource.resourceName}</option>)}
                    </datalist>
                </div>
              <div className="error"></div>
              </div>
              <div className="col-md-6 form-group" id="UpdateResourceResourceTypeField">
                <label className="form-label">Resource Type</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="resourceType"
                    required
                    name="resourceType"
                    className="form-control"
                    value={formValues.resourceType}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceResourceTypeField'), 'select')}
                    onChange={(e: any)=>{handleChange(e);
                      manageCheckBox(e);
                      validateSingleFormGroup(document.getElementById('UpdateResourceResourceTypeField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {resourceTypes.map((resourceType: any) => (<option key={resourceType} value={resourceType}>{resourceType}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group" id="">
                <div className="" style={{alignItems:'center', marginTop:'12.5%'}}>
                  <input type="checkbox" onChange={handleChange} id="PartTimeField" disabled={disableCheckBox} name="PartTimeField" checked={isPartTime} value="partTime"/>
                  <label className="form-label" style={{marginLeft:'5px'}}>Part Time</label>
                </div>
              </div>
              <div className="col-md-6 form-group" id="UpdateResourceMarketField">
                <label className="form-label">Market</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="market"
                    required
                    name="resourceMarket"
                    className="form-control"
                    value={formValues.resourceMarket}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceMarketField'), 'select')}
                    onChange={(e: any)=>{handleChange(e);
                      validateSingleFormGroup(document.getElementById('UpdateResourceMarketField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {marketList.filter((market: any) => market.status == "Active").map((market: any) => <option key={market.id} value={market.marketName}>{market.marketName}</option>)}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group" id="UpdateResourceLocationField">
                <label className="form-label">Location</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    id="location"
                    required
                    name="location"
                    className="form-control"
                    value={formValues.location}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceLocationField'), 'select')}
                    onChange={(e: any)=>{handleChange(e);
                      validateSingleFormGroup(document.getElementById('UpdateResourceLocationField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {locations.map((location: any) => (<option key={location.locationId} value={location.locationName}> {location.locationName}</option>))}
                  </select>
                <div className="error"></div>
                </div>
              </div>

              <div className="col-md-6 form-group " id="UpdateResourceSubLocationField">
                <label className="form-label">Sub Location</label>
                <span className="requiredField">*</span>
                <div className="dropdown">
                  <select
                    name="subLocation"
                    required
                    className="form-control"
                    id="holidaySubLocation"
                    value={formValues.subLocation}
                    // onBlur={()=>validateSingleFormGroup(document.getElementById('UpdateResourceSubLocationField'), 'select')}
                    onChange={(e: any)=>{handleChange(e);
                      validateSingleFormGroup(document.getElementById('UpdateResourceSubLocationField'), 'select');
                    }}
                  >
                    <option value="0">Select</option>
                    {location == "0" ? [] : (subLocations.filter((subLocation: any) => location == subLocation.locationName).map((subLocation: any) => (<option key={subLocation.subLocationId} value={subLocation.subLocationName}>{subLocation.subLocationName}</option>)))}
                  </select>
                <div className="error"></div>
                </div>
              </div>
              <div className="col-md-6 form-group ">
                <label className="form-label">Status</label>
                <div className="dropdown">
                  <select
                    name="isActive"
                    className="form-control"
                    id="statusDropdown"
                    value={formValues.isActive}
                    onChange={handleChange}
                  >
                    <option value="0">Select</option>
                    <option value="Active">Active</option>
                    <option value="Closed">Closed</option>
                    <option value="InActive">InActive</option>
                    <option value="Pending">Pending</option>
                  </select>
                </div>
              </div>

            </div>
            <div className="row">
              <div className="col-md-8">
                
              </div>
              <div className="col-md-4" >
              <button  type="button" onClick={deleteConfirmation} className="btn btn-primary " style={{ float: "right" }}>
                  Delete
              </button>
              <button type="submit" className="btn btn-primary updateButton">
                  Update
                </button>
              </div>
            </div>
          </form>
        </Modal.Body>
      </Modal>
    </>
  );
}

export default EmployeeMaster;
